# Smart Contract Interaction Scripts

This documentation provides an overview of the scripts used to deploy, interact with, and manage the `EcomercePayment` smart contract. These scripts are designed for a development environment using Hardhat and a local blockchain network like Ganache.

## Table of Contents
1.  [Overview](#overview)
2.  [Prerequisites](#prerequisites)
3.  [Core Files](#core-files)
    -   [`deploy.js`](#deployjs)
    -   [`createOrder.js`](#createorderjs)
    -   [`processPayment.js`](#processpaymentjs)
    -   [`utils.js`](#utilsjs)
    -   [`contract-info.json`](#contract-infojson)
4.  [Hardhat Configuration](#hardhat-configuration)
5.  [Workflow](#workflow)
    -   [Step 1: Start Your Local Blockchain](#step-1-start-your-local-blockchain)
    -   [Step 2: Deploy the Contracts](#step-2-deploy-the-contracts)
    -   [Step 3: Create an Order](#step-3-create-an-order)
    -   [Step 4: Process a Payment](#step-4-process-a-payment)
6.  [Running Tests](#running-tests)

---

## Overview

These scripts provide a command-line interface for managing the lifecycle of an e-commerce transaction on the blockchain. They handle deploying the necessary contracts, creating new orders, and processing payments for those orders.

## Prerequisites

-   **Node.js** and **npm** installed.
-   **Ganache**: A local blockchain instance must be running. You can download it from the [Truffle Suite website](https://trufflesuite.com/ganache/).
-   **Hardhat Project**: The scripts must be run within this Hardhat project's root directory.
-   **Dependencies**: Run `npm install` to install all required packages.

## Core Files

### `deploy.js`
-   **Purpose**: Deploys the `EcomercePayment` and `MockERC20` contracts to the blockchain. It also initializes the system by registering the `MockERC20` token as a supported payment method in the `EcomercePayment` contract.
-   **Output**: Creates a `contract-info.json` file containing the addresses and ABIs of the deployed contracts. This file is crucial for other scripts to locate and interact with the contracts.
-   **Command**:
    ```bash
    npx hardhat run scripts/deploy.js --network <your-network>
    ```

### `createOrder.js`
-   **Purpose**: Creates a new payment order on the `EcomercePayment` contract. It uses the second account from your network provider as the "buyer".
-   **Details**: It reads the contract addresses from `contract-info.json` and sends a transaction to create an order with a predefined amount. The script logs the newly created `orderId` to the console.
-   **Command**:
    ```bash
    npx hardhat run scripts/createOrder.js --network <your-network>
    ```

### `processPayment.js`
-   **Purpose**: Processes the payment for a specific order. This script is executed via a custom Hardhat task to allow for dynamic `orderId` input.
-   **Details**:
    1.  Reads the `orderId` passed from the command line.
    2.  Verifies that the order exists and is in a `Pending` state.
    3.  Mints the required tokens to the buyer.
    4.  Approves the `EcomercePayment` contract to spend the buyer's tokens.
    5.  Executes the payment transaction.
    6.  Logs the buyer's and contract's token balances before and after the transaction to show the transfer of funds.
-   **Command**:
    ```bash
    npx hardhat process-payment --network <your-network> --orderid <ID>
    ```

### `utils.js`
-   **Purpose**: A utility module containing shared functions used by the other scripts.
-   **Features**:
    -   `getContractInfo()`: Safely reads and parses `contract-info.json`.
    -   `getContracts()`: Returns initialized `ethers.js` contract instances.
    -   `PaymentStatus`: An enum that mirrors the one in the smart contract for consistent status checks.
    -   `getStatusString()`: Converts a status number from the contract into a human-readable string (e.g., `0` becomes "Pending").

### `contract-info.json`
-   **Purpose**: This file is automatically generated by `deploy.js` and acts as the single source of truth for the deployed contract addresses and ABIs. It allows scripts to interact with the contracts without hardcoding addresses.

## Hardhat Configuration

The `hardhat.config.js` file is configured to connect to your local Ganache instance and includes the custom `process-payment` task.

```javascript
task("process-payment", "Processes a payment for a given order ID")
  .addParam("orderid", "The ID of the order to process")
  .setAction(async (taskArgs, hre) => {
    process.env.ORDER_ID = taskArgs.orderid;
    await hre.run('run', { script: 'scripts/processPayment.js' });
  });
```

## Workflow

Follow these steps in order every time you start a new development session.

### Step 1: Start Your Local Blockchain
Launch your Ganache application.

### Step 2: Deploy the Contracts
Open a terminal and run the deploy script. This only needs to be done once per session.
```bash
npx hardhat run scripts/deploy.js --network ganache
```

### Step 3: Create an Order
Run the create order script. Each time you run this, a new order with a new ID will be created.
```bash
npx hardhat run scripts/createOrder.js --network ganache
```
> **Note**: Take note of the `orderId` logged in the console.

### Step 4: Process a Payment
Use the `process-payment` task and the `orderId` from the previous step to process the payment.
```bash
npx hardhat process-payment --network ganache --orderid 1
```

## Running Tests

The test suite can be run against your Ganache network to ensure all contract functionality works as expected.
```bash
npx hardhat test --network ganache
```
The tests have been configured to work with Ganache's error reporting by using a generic `.to.be.reverted` check instead of matching specific revert reasons.
